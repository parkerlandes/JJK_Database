import streamlit as st
from sqlalchemy.orm import Session
from database import SessionLocal
import models
from llm_query import answer_query

def get_session():
    return SessionLocal()

session = get_session()

# =======================
# GENERAL UI
# =======================
st.set_page_config(page_title="JJK Database", layout="wide")

st.markdown("""
<style>
    .main-title {
        font-size:34px !important;
        font-weight:700 !important;
        margin-bottom:10px;
    }
    .section-title {
        font-size:22px !important;
        font-weight:600 !important;
        margin-top:25px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 4px;
    }
</style>
""", unsafe_allow_html=True)

st.markdown("<div class='main-title'>Jujutsu Kaisen Database</div>", unsafe_allow_html=True)


# =======================
# SIDEBAR NAVIGATION
# =======================

st.sidebar.markdown("## Database Tools")

with st.sidebar.expander("CRUD Operations", expanded=True):
    crud_action = st.radio(
        "Select Operation", 
        [
            "View Characters",
            "View Episodes",
            "View Fights",
            "View Techniques",
            "View Clans",
            "View Locations",
            "Add Character",
            "Add Arc",
            "Add Episode",
            "Add Domain",
            "Add Technique",
            "Add Fight",
            "Add Location",
            "Delete Character"
        ],
        key="crud_select"
    )

# Persistent AI mode
if "ai_mode" not in st.session_state:
    st.session_state.ai_mode = False

if st.sidebar.button("Ask Database (AI)", key="ai_button"):
    st.session_state.ai_mode = True

# =======================
# VIEW - CHARACTERS
# =======================

elif crud_action == "View Characters":
    st.markdown("<div class='section-title'>Characters</div>", unsafe_allow_html=True)

    chars = session.query(models.Character).all()

    for c in chars:
        with st.expander(f"{c.name}"):

            st.write(f"**Grade:** {c.grade}")
            st.write(f"**Description:** {c.description}")

            # Show clan
            clan = session.query(models.Clan).filter_by(clan_id=c.clan_id).first()
            st.write(f"**Clan:** {clan.name if clan else 'None'}")

            # Show techniques
            char_techs = session.query(models.CharacterTechnique).filter_by(character_id=c.character_id).all()
            if char_techs:
                st.write("### Techniques:")
                for ct in char_techs:
                    tech = session.query(models.CursedTechnique).filter_by(technique_id=ct.technique_id).first()
                    type_str = "Innate" if ct.is_innate else "Learned"
                    st.write(f"- {tech.name} ({type_str})")
            else:
                st.write("No techniques assigned.")

            # Show domain
            dom = session.query(models.Domain).filter_by(character_id=c.character_id).first()
            st.write(f"**Domain:** {dom.name if dom else 'None'}")


# =======================
# VIEW — EPISODES
# =======================

elif crud_action == "View Episodes":
    st.markdown("<div class='section-title'>Episodes</div>", unsafe_allow_html=True)

    eps = session.query(models.Episode).order_by(
        models.Episode.season_number.asc(),
        models.Episode.episode_number.asc()
    ).all()

    for e in eps:

        arc = session.query(models.Arc).filter_by(arc_id=e.arc_id).first()

        fights = session.query(models.Fight).filter(
            (models.Fight.start_episode_id <= e.episode_id) &
            (models.Fight.end_episode_id >= e.episode_id)
        ).all()

        characters = session.query(models.Character).filter_by(
            first_appearance_episode_id=e.episode_id
        ).all()

        with st.expander(f"S{e.season_number}E{e.episode_number} — {e.title}"):

            st.write(f"**Arc:** {arc.arc_name if arc else 'None'}")
            st.write(f"**Season:** {e.season_number}")
            st.write(f"**Episode Number:** {e.episode_number}")
            st.write(f"**Synopsis:** {e.synopsis}")

            # ==============================
            # Show fights involving this episode
            # ==============================
            if fights:
                st.write("### Fights in this episode:")
                for f in fights:
                    st.write(f"- {f.name}")
            else:
                st.write("No fights in this episode.")

            # ==============================
            # Characters whose first appearance is this episode
            # ==============================
            if characters:
                st.write("### Characters introduced:")
                for c in characters:
                    st.write(f"- {c.name}")
            else:
                st.write("No new characters introduced in this episode.")


# =======================
# VIEW — FIGHTS
# =======================

elif crud_action == "View Fights":
    st.markdown("<div class='section-title'>Fights</div>", unsafe_allow_html=True)

    fights = session.query(models.Fight).order_by(models.Fight.start_episode_id.asc()).all()

    if not fights:
        st.write("No fights found in the database.")
    else:
        for f in fights:
            arc = session.query(models.Arc).filter_by(arc_id=f.arc_id).first()
            loc = session.query(models.Location).filter_by(location_id=f.location_id).first()
            ep_start = session.query(models.Episode).filter_by(episode_id=f.start_episode_id).first()
            ep_end = session.query(models.Episode).filter_by(episode_id=f.end_episode_id).first()
            participants = session.query(models.FightParticipant).filter_by(fight_id=f.fight_id).all()

            with st.expander(f"{f.name}"):

                # BASIC INFO
                st.write(f"**Arc:** {arc.arc_name}")
                st.write(f"**Location:** {loc.name}")
                st.write(f"**Episode Range:** {ep_start.episode_number} – {ep_end.episode_number}")
                st.write(f"**Summary:** {f.summary}")

                # PARTICIPANT TABLE
                st.write("### Participants:")

                for p in participants:
                    char = session.query(models.Character).filter_by(character_id=p.character_id).first()
                    st.write(f"- {char.name}: **{p.outcome.upper()}**")


# =======================
# VIEW - TECHNIQUES
# =======================
elif crud_action == "View Techniques":
    st.markdown("<div class='section-title'>Techniques</div>", unsafe_allow_html=True)

    techs = session.query(models.CursedTechnique).all()

    for t in techs:
        with st.expander(f"{t.name}"):

            st.write(f"**Description:** {t.description}")

            # list users of this technique
            users = session.query(models.CharacterTechnique).filter_by(
                technique_id=t.technique_id
            ).all()

            if users:
                st.write("### Users:")
                for ct in users:
                    char = session.query(models.Character).filter_by(
                        character_id=ct.character_id
                    ).first()

                    type_str = "Innate" if ct.is_innate else "Learned"
                    st.write(f"- {char.name} ({type_str})")
            else:
                st.write("No characters use this technique.")



# =======================
# VIEW - CLANS
# =======================
elif crud_action == "View Clans":
    st.markdown("<div class='section-title'>Clans</div>", unsafe_allow_html=True)

    clans = session.query(models.Clan).all()

    for clan in clans:
        with st.expander(clan.name):

            # List members
            members = session.query(models.Character).filter_by(clan_id=clan.clan_id).all()

            st.write("### Members:")
            for m in members:
                st.write(f"- {m.name}")

            # Find techniques used by >50% of clan
            clan_member_ids = [m.character_id for m in members]

            tech_usage = session.query(models.CharacterTechnique).filter(
                models.CharacterTechnique.character_id.in_(clan_member_ids)
            ).all()

            tech_count = {}
            for t in tech_usage:
                tech_count[t.technique_id] = tech_count.get(t.technique_id, 0) + 1

            dominant_techs = [
                tech_id for tech_id, count in tech_count.items()
                if count >= len(members)/2
            ]

            if dominant_techs:
                st.write("### Clan Techniques:")
                for tid in dominant_techs:
                    t = session.query(models.CursedTechnique).filter_by(technique_id=tid).first()
                    st.write(f"- {t.name}")
            else:
                st.write("No clan-wide techniques identified.")


# =======================
# VIEW — LOCATIONS
# =======================
elif crud_action == "View Locations":
    st.markdown("<div class='section-title'>Locations</div>", unsafe_allow_html=True)

    locations = session.query(models.Location).all()

    for l in locations:
        with st.expander(f"{l.name}"):
            st.write(f"**Type:** {l.type}")
            st.write(f"**City:** {l.city}")
            st.write(f"**Country:** {l.country}")



# =======================
# CRUD — ADD CHARACTER
# =======================

elif crud_action == "Add Character":
    st.markdown("<div class='section-title'>Add New Character</div>", unsafe_allow_html=True)

    name = st.text_input("Name")
    grade = st.text_input("Grade")
    desc = st.text_area("Description")

    if st.button("Add Character"):
        new_char = models.Character(name=name, grade=grade, description=desc)
        session.add(new_char)
        session.commit()
        st.success("Character added.")


# =======================
# CRUD — ADD ARC
# =======================

elif crud_action == "Add Arc":
    st.markdown("<div class='section-title'>Add Arc</div>", unsafe_allow_html=True)

    series_list = session.query(models.Series).all()
    s = st.selectbox("Series", [x.name for x in series_list])

    selected_series = session.query(models.Series).filter_by(name=s).first()
    arc_name = st.text_input("Arc Name")
    arc_desc = st.text_area("Arc Description")

    if st.button("Create Arc"):
        new_arc = models.Arc(
            series_id=selected_series.series_id,
            arc_name=arc_name,
            description=arc_desc
        )
        session.add(new_arc)
        session.commit()
        st.success("Arc added.")


# =======================
# CRUD — ADD EPISODE
# =======================

elif crud_action == "Add Episode":
    st.markdown("<div class='section-title'>Add Episode</div>", unsafe_allow_html=True)

    arc_list = session.query(models.Arc).all()
    selected_arc = st.selectbox("Arc", [x.arc_name for x in arc_list])
    selected_arc_obj = session.query(models.Arc).filter_by(arc_name=selected_arc).first()

    season = st.number_input("Season Number", min_value=1)
    ep_no = st.number_input("Episode Number", min_value=1)
    title = st.text_input("Title")
    synopsis = st.text_area("Synopsis")

    if st.button("Create Episode"):
        ep = models.Episode(
            arc_id=selected_arc_obj.arc_id,
            season_number=season,
            episode_number=ep_no,
            title=title,
            synopsis=synopsis
        )
        session.add(ep)
        session.commit()
        st.success("Episode added.")


# =======================
# CRUD — ADD DOMAIN
# =======================

elif crud_action == "Add Domain":
    st.markdown("<div class='section-title'>Add Domain</div>", unsafe_allow_html=True)

    chars = session.query(models.Character).all()
    c = st.selectbox("Character", [x.name for x in chars])
    selected_char = session.query(models.Character).filter_by(name=c).first()

    dom_name = st.text_input("Domain Name")
    dom_desc = st.text_area("Domain Description")

    if st.button("Create Domain"):
        new_domain = models.Domain(
            character_id=selected_char.character_id,
            name=dom_name,
           description=dom_desc
        )
        session.add(new_domain)
        session.commit()
        st.success("Domain added.")


# =======================
# CRUD — ADD CURSED TECHNIQUE
# =======================

elif crud_action == "Add Technique":
    st.markdown("<div class='section-title'>Add Cursed Technique</div>", unsafe_allow_html=True)

    tech_name = st.text_input("Technique Name")
    tech_desc = st.text_area("Technique Description")

    chars = session.query(models.Character).all()
    char_names = [c.name for c in chars]

    selected_users = st.multiselect("Which characters use this technique?", char_names)

    is_innate_flags = {}
    for name in selected_users:
        is_innate_flags[name] = st.checkbox(f"Is {name}'s use of this technique innate?", value=False)

    if st.button("Create Technique"):
        # STEP 1 — CHECK IF TECHNIQUE ALREADY EXISTS
        existing_tech = session.query(models.CursedTechnique).filter_by(name=tech_name).first()

        if existing_tech:
            tech_obj = existing_tech
            st.warning(f"Technique '{tech_name}' already exists. Linking characters only.")
        else:
            # create new technique
            tech_obj = models.CursedTechnique(
                name=tech_name,
                description=tech_desc
            )
            session.add(tech_obj)
            session.commit()
            st.success(f"Technique '{tech_name}' created.")

        # STEP 2 — ADD CHARACTERS FOR TECHNIQUE
        for name in selected_users:
            char = session.query(models.Character).filter_by(name=name).first()

            # prevent duplicate mapping
            existing_relation = session.query(models.CharacterTechnique).filter_by(
                character_id=char.character_id,
                technique_id=tech_obj.technique_id
            ).first()

            if existing_relation:
                st.warning(f"{name} is already associated with {tech_name}.")
                continue

            # create technique relation
            ct = models.CharacterTechnique(
                character_id=char.character_id,
                technique_id=tech_obj.technique_id,
                is_innate=is_innate_flags[name]
            )
            session.add(ct)

            # STEP 3 — ADD TO inherited_technique IF INNATE
            if is_innate_flags[name]:
                existing_inh = session.query(models.InheritedTechnique).filter_by(
                    character_id=char.character_id,
                    name=f"Inherited: {tech_name}"
                ).first()

                if not existing_inh:
                    inh = models.InheritedTechnique(
                        character_id=char.character_id,
                        name=f"Inherited: {tech_name}",
                        description=f"Inherited use of {tech_name}"
                    )
                    session.add(inh)

        session.commit()
        st.success("Technique + user relationships successfully processed!")



# =======================
# CRUD — ADD FIGHT 
# =======================

elif crud_action == "Add Fight":
    st.markdown("<div class='section-title'>Add Fight</div>", unsafe_allow_html=True)

    # SELECT ARC
    arcs = session.query(models.Arc).all()
    arc_name = st.selectbox("Select Arc", [a.arc_name for a in arcs])
    arc_obj = session.query(models.Arc).filter_by(arc_name=arc_name).first()

    # SELECT LOCATION
    locations = session.query(models.Location).all()
    loc_name = st.selectbox("Select Location", [l.name for l in locations])
    loc_obj = session.query(models.Location).filter_by(name=loc_name).first()

    # FILTER EPISODES BY ARC — ✨ NEW
    episodes = session.query(models.Episode).filter_by(arc_id=arc_obj.arc_id).all()
    episode_display = [f"EP {e.episode_number}" for e in episodes]

    start_ep = st.selectbox("Start Episode", episode_display)
    end_ep = st.selectbox("End Episode", episode_display)

    start_ep_obj = episodes[episode_display.index(start_ep)]
    end_ep_obj = episodes[episode_display.index(end_ep)]

    # FIGHT NAME + SUMMARY
    fight_name = st.text_input("Fight Name")
    fight_summary = st.text_area("Fight Summary")

    # CHARACTER PARTICIPANTS
    st.markdown("### Fight Participants:")

    all_chars = session.query(models.Character).all()
    fighter_names = st.multiselect("Select fighters", [c.name for c in all_chars])

    outcomes = {}
    for fname in fighter_names:
        outcomes[fname] = st.selectbox(
            f"Outcome for {fname}",
            ["winner", "loser", "draw", "unknown"],
            key=f"out_{fname}"
        )

    # ===========================
    # VALIDATION + COMMIT RULES
    # ===========================
    if st.button("Create Fight"):
        
        # ❗ 1) Must select at least 2 fighters
        if len(fighter_names) < 2:
            st.error("You must select at least TWO fighters.")
            st.stop()

        # ❗ 2) draw must only be used if EVERYONE is draw
        if "draw" in outcomes.values() and not all(o == "draw" for o in outcomes.values()):
            st.error("A 'draw' outcome may only be used if ALL participants are assigned 'draw'.")
            st.stop()

        # ❗ 3) start episode <= end episode
        if start_ep_obj.episode_number > end_ep_obj.episode_number:
            st.error("Start episode cannot be AFTER end episode.")
            st.stop()

        # ❗ 4) BOTH episodes must be inside arc (this is guaranteed now)
        if start_ep_obj.arc_id != arc_obj.arc_id or end_ep_obj.arc_id != arc_obj.arc_id:
            st.error("Selected episodes do not belong to the same arc.")
            st.stop()

        # ===========================
        # INSERT FIGHT
        # ===========================
        new_fight = models.Fight(
            name=fight_name,
            arc_id=arc_obj.arc_id,
            location_id=loc_obj.location_id,
            start_episode_id=start_ep_obj.episode_id,
            end_episode_id=end_ep_obj.episode_id,
            summary=fight_summary
        )
        session.add(new_fight)
        session.commit()

        # ===========================
        # INSERT PARTICIPANTS
        # ===========================
        for fname in fighter_names:
            char_obj = session.query(models.Character).filter_by(name=fname).first()
            fp = models.FightParticipant(
                fight_id=new_fight.fight_id,
                character_id=char_obj.character_id,
                outcome=outcomes[fname]
            )
            session.add(fp)

        session.commit()
        st.success("Fight and participants successfully added.")


# =======================
# CRUD — ADD LOCATION
# =======================

elif crud_action == "Add Location":
    st.markdown("<div class='section-title'>Add Location</div>", unsafe_allow_html=True)

    loc_name = st.text_input("Location Name (ex: Tokyo Metropolitan Jujutsu High)")
    loc_type = st.text_input("Type (ex: school, city, district, landmark, battlefield)")
    loc_city = st.text_input("City (e.g., Tokyo)")
    loc_country = st.text_input("Country (e.g., Japan)")

    if st.button("Create Location"):
        new_loc = models.Location(
            name=loc_name,
            type=loc_type,
            city=loc_city,
            country=loc_country
        )
        session.add(new_loc)
        session.commit()
        st.success("Location added.")

# =======================
# CRUD — DELETE CHARACTER
# =======================

elif crud_action == "Delete Character":
    st.markdown("<div class='section-title'>Delete Character</div>", unsafe_allow_html=True)

    chars = session.query(models.Character).all()
    selected = st.selectbox("Select character", [c.name for c in chars])

    if st.button("Delete"):
        obj = session.query(models.Character).filter_by(name=selected).first()
        session.delete(obj)
        session.commit()
        st.success("Character deleted.")


# =======================
# AI QUERY SECTION (Persistent)
# =======================

if st.session_state.ai_mode:
    st.markdown("<div class='section-title'>Ask Database (AI)</div>", unsafe_allow_html=True)
    st.write("Ask a question like: 'What clan is Megumi in?' or 'List all episodes in the Shibuya arc.'")

    if "ai_query" not in st.session_state:
        st.session_state.ai_query = ""

    query = st.text_input("Ask a question", value=st.session_state.ai_query, key="ai_text")

    # Store input on change
    st.session_state.ai_query = query

    if st.button("Ask", key="ask_ai_button"):
        with st.spinner("Querying database using AI…"):
            res = answer_query(query)
        st.write(res)